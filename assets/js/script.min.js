const API_BASE="https://api.alquran.cloud/v1",state={currentSurah:"selectSurah",currentAyah:null,currentEdition:"selectTafsir",currentAudioEdition:"selectAudio",autoplayEnabled:!1,loopEnabled:!1,rangeModeEnabled:!1,rangeStart:1,rangeEnd:1,totalAyahs:1},elements={surahSelect:document.getElementById("surahSelect"),editionSelect:document.getElementById("editionSelect"),audioEditionSelect:document.getElementById("audioEditionSelect"),loading:document.getElementById("loading"),error:document.getElementById("error"),arabicText:document.getElementById("arabicText"),translationText:document.getElementById("translationText"),surahInfo:document.getElementById("surahInfo"),ayahInfo:document.getElementById("ayahInfo"),quranAudio:document.getElementById("quranAudio"),prevAyah:document.getElementById("prevAyah"),nextAyah:document.getElementById("nextAyah"),toggleAutoplay:document.getElementById("toggleAutoplay"),toggleLoop:document.getElementById("toggleLoop"),toggleRangeMode:document.getElementById("toggleRangeMode"),rangeControls:document.getElementById("rangeControls"),rangeStart:document.getElementById("rangeStart"),rangeEnd:document.getElementById("rangeEnd"),setRange:document.getElementById("setRange"),autoPlay:document.getElementById("toggleAutoplay"),loop:document.getElementById("toggleLoop"),rangeMode:document.getElementById("toggleRangeMode"),quranContent:document.getElementById("quranContent")},allowedIdentifiers={text:["ar.baghawi","ar.jalalayn","ar.miqbas","ar.muyassar","ar.qurtubi","ar.waseet","quran-uthmani",],audio:["ar.abdullahbasfar","ar.abdulsamad","ar.abdurrahmaansudais","ar.ahmedajamy","ar.alafasy","ar.aymanswoaid","ar.hanirifai","ar.hudhaify","ar.husary","ar.husarymujawwad","ar.ibrahimakhbar","ar.mahermuaiqly","ar.muhammadayyoub","ar.muhammadjibreel","ar.saoodshuraym","ar.shaatree",]};function showLoading(e){elements.loading.style.display=e?"block":"none",e&&(elements.error.style.display="none")}function showError(e){elements.error.textContent=e,elements.error.style.display="block",elements.loading.style.display="none"}function updateToggleButton(e,t,a){e.textContent=`${t}: ${a?"On":"Off"}`,e.classList.toggle("active",a)}async function fetchApi(e){try{let t=await fetch(`https://api.alquran.cloud/v1${e}`);if(!t.ok)throw Error("Network response was not ok");return await t.json()}catch(a){throw showError(a.message),a}}async function loadEditions(){showLoading(!0);try{let[e,t]=await Promise.all([fetchApi("/edition?format=text"),fetchApi("/edition?format=audio&type=versebyverse"),]);e.data.filter(e=>allowedIdentifiers.text.includes(e.identifier)&&"quran-uthmani"!==e.identifier).forEach(e=>{let t=new Option(e.name,e.identifier);elements.editionSelect.add(t)}),t.data.filter(e=>allowedIdentifiers.audio.includes(e.identifier)).forEach(e=>{let t=new Option(e.name,e.identifier);elements.audioEditionSelect.add(t)})}catch(a){showError("فشل في تحميل البيانات")}showLoading(!1)}async function loadSurahs(){showLoading(!0);try{let e=await fetchApi("/surah");e.data.forEach(e=>{let t=new Option(`${e.number}. ${e.englishName} (${e.name})`,e.number);elements.surahSelect.add(t)})}catch(t){showError("فشل في تحميل السورة")}showLoading(!1)}async function loadAyah(e,t,a=state.currentEdition){showLoading(!0);try{let n=await fetchApi(`/ayah/${e}:${t}/quran-uthmani`),r=n.data,s="";s=r.text;let l="",d="";if(a&&"selectTafsir"!==a){let o=await fetchApi(`/ayah/${e}:${t}/${a}`);l=o.data.text,d=o.data.edition.name}if(elements.arabicText.innerHTML=`
            <div class="verse-container">
              <div class="arabic">${s}</div>
              ${l?`<div class="edition-label">${d}</div>
                     <div class="translation">${l}</div>`:""}
            </div>
          `,elements.surahInfo.textContent=`Surah ${r.surah.englishName} (${r.surah.name})`,elements.ayahInfo.textContent=`الأية ${r.numberInSurah} من ${r.surah.numberOfAyahs}`,state.totalAyahs=r.surah.numberOfAyahs,elements.rangeStart.addEventListener("input",validateRangeInput),elements.rangeEnd.addEventListener("input",validateRangeInput),state.currentAudioEdition&&"selectAudio"!==state.currentAudioEdition){let i=await fetchApi(`/ayah/${e}:${t}/${state.currentAudioEdition}`);elements.quranAudio.src=i.data.audio,state.autoplayEnabled&&elements.quranAudio.play()}updateNavigationButtons(r.numberInSurah,r.surah.numberOfAyahs),state.currentSurah=e,state.currentAyah=t,saveState()}catch(u){showError("فشل في تحميل الأية")}showLoading(!1)}function validateRangeInput(e){let t=Number(e.target.value);t>state.totalAyahs?e.target.value=state.totalAyahs:t<1&&(e.target.value=1)}function updateNavigationButtons(e,t){state.rangeModeEnabled?(elements.prevAyah.disabled=e<=state.rangeStart,elements.nextAyah.disabled=e>=state.rangeEnd):(elements.prevAyah.disabled=1===e,elements.nextAyah.disabled=e===t)}function updateControlsVisibility(){let e="selectSurah"!==elements.surahSelect.value,t="selectAudio"!==elements.audioEditionSelect.value;elements.quranAudio.classList.toggle("hidden",!(e&&t)),elements.prevAyah.classList.toggle("hidden",!e),elements.nextAyah.classList.toggle("hidden",!e),elements.quranContent.classList.toggle("hidden",!e),elements.autoPlay.classList.toggle("hidden",!(e&&t)),elements.loop.classList.toggle("hidden",!(e&&t)),elements.rangeMode.classList.toggle("hidden",!e)}function handleAudioEnd(){state.loopEnabled?elements.quranAudio.play():state.autoplayEnabled&&(state.rangeModeEnabled?state.currentAyah<state.rangeEnd?loadAyah(state.currentSurah,state.currentAyah+1):state.loopEnabled&&loadAyah(state.currentSurah,state.rangeStart):state.currentAyah<state.totalAyahs&&loadAyah(state.currentSurah,state.currentAyah+1))}function saveState(){localStorage.setItem("Al-Munir_State",JSON.stringify(state))}function loadState(){let e=localStorage.getItem("Al-Munir_State");if(e)try{Object.assign(state,JSON.parse(e)),elements.surahSelect.value=state.currentSurah,elements.editionSelect.value=state.currentEdition,elements.audioEditionSelect.value=state.currentAudioEdition,updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",state.autoplayEnabled),updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",state.loopEnabled),updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",state.rangeModeEnabled),elements.rangeStart.value=state.rangeStart,elements.rangeEnd.value=state.rangeEnd,elements.rangeControls.style.display=state.rangeModeEnabled?"flex":"none",state.currentSurah&&state.currentAyah&&loadAyah(state.currentSurah,state.currentAyah,state.currentEdition)}catch(t){showError("فشل تحميل الحالة المحفوظة")}updateControlsVisibility()}function initializeHiddenElements(){elements.quranAudio.classList.add("hidden"),elements.prevAyah.classList.add("hidden"),elements.nextAyah.classList.add("hidden"),elements.quranContent.classList.add("hidden"),elements.autoPlay.classList.add("hidden"),elements.loop.classList.add("hidden"),elements.rangeMode.classList.add("hidden")}function setupEventListeners(){elements.quranAudio.addEventListener("ended",handleAudioEnd),elements.toggleAutoplay.addEventListener("click",()=>{state.autoplayEnabled=!state.autoplayEnabled,updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",state.autoplayEnabled),saveState()}),elements.toggleLoop.addEventListener("click",()=>{state.loopEnabled=!state.loopEnabled,updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",state.loopEnabled),saveState()}),elements.toggleRangeMode.addEventListener("click",()=>{state.rangeModeEnabled=!state.rangeModeEnabled,updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",state.rangeModeEnabled),elements.rangeControls.style.display=state.rangeModeEnabled?"flex":"none",state.rangeModeEnabled&&(elements.rangeStart.value=state.currentAyah||1,elements.rangeEnd.value=state.totalAyahs,state.rangeStart=state.currentAyah||1,state.rangeEnd=state.totalAyahs),updateNavigationButtons(state.currentAyah||1,state.totalAyahs),saveState()}),elements.setRange.addEventListener("click",()=>{state.rangeStart=parseInt(elements.rangeStart.value),state.rangeEnd=parseInt(elements.rangeEnd.value),state.rangeStart>state.rangeEnd&&([state.rangeStart,state.rangeEnd]=[state.rangeEnd,state.rangeStart],elements.rangeStart.value=state.rangeStart,elements.rangeEnd.value=state.rangeEnd),!state.currentAyah||state.currentAyah<state.rangeStart||state.currentAyah>state.rangeEnd?loadAyah(state.currentSurah,state.rangeStart):updateNavigationButtons(state.currentAyah,state.totalAyahs),saveState()}),elements.prevAyah.addEventListener("click",()=>{let e=state.rangeModeEnabled?state.rangeStart:1;state.currentAyah>e&&loadAyah(state.currentSurah,state.currentAyah-1)}),elements.nextAyah.addEventListener("click",()=>{let e=state.rangeModeEnabled?state.rangeEnd:state.totalAyahs;state.currentAyah<e&&loadAyah(state.currentSurah,state.currentAyah+1)}),elements.surahSelect.addEventListener("change",e=>{let t=e.target.value;t&&"selectSurah"!==t&&(state.currentSurah=parseInt(t),state.currentAyah=1,loadAyah(state.currentSurah,state.currentAyah),updateControlsVisibility())}),elements.editionSelect.addEventListener("change",e=>{e.target.value&&(state.currentEdition=e.target.value,loadAyah(state.currentSurah,state.currentAyah))}),elements.audioEditionSelect.addEventListener("change",e=>{e.target.value&&(state.currentAudioEdition=e.target.value,loadAyah(state.currentSurah,state.currentAyah),updateControlsVisibility())})}async function init(){initializeHiddenElements(),setupEventListeners(),await Promise.all([loadSurahs(),loadEditions()]),loadState()}init();
