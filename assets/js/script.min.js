const state={currentSurah:"selectSurah",currentAyah:null,currentEdition:"selectTafsir",currentAudioEdition:"selectAudio",autoplayEnabled:!1,loopEnabled:!1,rangeModeEnabled:!1,rangeStart:1,rangeEnd:1,totalAyahs:1},elements={surahSelect:document.getElementById("surahSelect"),editionSelect:document.getElementById("editionSelect"),audioEditionSelect:document.getElementById("audioEditionSelect"),loading:document.getElementById("loading"),error:document.getElementById("error"),arabicText:document.getElementById("arabicText"),translationText:document.getElementById("translationText"),surahInfo:document.getElementById("surahInfo"),ayahInfo:document.getElementById("ayahInfo"),quranAudio:document.getElementById("quranAudio"),prevAyah:document.getElementById("prevAyah"),nextAyah:document.getElementById("nextAyah"),toggleAutoplay:document.getElementById("toggleAutoplay"),toggleLoop:document.getElementById("toggleLoop"),toggleRangeMode:document.getElementById("toggleRangeMode"),rangeControls:document.getElementById("rangeControls"),rangeStart:document.getElementById("rangeStart"),rangeEnd:document.getElementById("rangeEnd"),setRange:document.getElementById("setRange"),autoPlay:document.getElementById("toggleAutoplay"),loop:document.getElementById("toggleLoop"),rangeMode:document.getElementById("toggleRangeMode"),quranContent:document.getElementById("quranContent")},excludedIdentifiers={audio:["ar.parhizgar"],text:["quran-buck","quran-corpus-qd","quran-kids","quran-simple-clean","quran-simple-enhanced","quran-simple-min","quran-simple","quran-tajweed","quran-unicode","quran-uthmani-quran-academy","quran-wordbyword-2","quran-wordbyword","quran-uthmani","quran-uthmani-min",]};function showLoading(e){elements.loading.style.display=e?"block":"none",e&&(elements.error.style.display="none")}function showError(e){elements.error.textContent=e,elements.error.style.display="block",elements.loading.style.display="none"}function updateToggleButton(e,t,a){e.textContent=`${t}: ${a?"On":"Off"}`,e.classList.toggle("active",a)}async function loadJSON(e){try{let t=await fetch(`./assets/data/${e}`);if(!t.ok)throw Error("فشل تحميل ملف JSON");return await t.json()}catch(a){throw showError(`فشل تحميل ملف ${e}: ${a.message}`),a}}async function loadEditions(){showLoading(!0);try{let[e,t]=await Promise.all([loadJSON("arabic_text_editions.json"),loadJSON("arabic_audio_editions.json"),]);e.data.forEach(e=>{if(excludedIdentifiers.text.includes(e.identifier))return;let t=new Option(e.name,e.identifier);elements.editionSelect.add(t)}),t.data.forEach(e=>{if(excludedIdentifiers.audio.includes(e.identifier))return;let t=new Option(e.name,e.identifier);elements.audioEditionSelect.add(t)})}catch(a){showError("فشل في تحميل ملفات التفسير والقراء")}showLoading(!1)}async function loadSurahs(){showLoading(!0);try{let e=await loadJSON("quran_text_quran-uthmani.json");e.data.surahs.forEach(e=>{let t=new Option(`${e.number}. ${e.englishName} (${e.name})`,e.number);elements.surahSelect.add(t)})}catch(t){showError("فشل في تحميل ملف السور")}showLoading(!1)}async function loadAyah(e,t,a=state.currentEdition){showLoading(!0);try{let n=await loadJSON("quran_text_quran-uthmani.json"),s=n.data.surahs[e-1],l=s.ayahs[t-1],r="",d="";if(a&&"selectTafsir"!==a){let o=await loadJSON(`quran_text_${a}.json`),i=o.data.surahs[e-1].ayahs[t-1];r=i.text,d=o.data.edition.name}if(elements.arabicText.innerHTML=`
      <div class="verse-container">
        <div class="arabic">${l.text}</div>
        ${r?`
          <div class="edition-label">${d}</div>
          <div class="translation">${r}</div>
        `:""}
      </div>
    `,elements.surahInfo.textContent=`Surah ${s.englishName} (${s.name})`,elements.ayahInfo.textContent=`الأية ${l.numberInSurah} من ${s.ayahs.length}`,state.totalAyahs=s.ayahs.length,elements.rangeStart.addEventListener("input",validateRangeInput),elements.rangeEnd.addEventListener("input",validateRangeInput),state.currentAudioEdition&&"selectAudio"!==state.currentAudioEdition){let u=await loadJSON(`quran_audio_${state.currentAudioEdition}.json`),g=u.data.surahs[e-1].ayahs[t-1];elements.quranAudio.src=g.audio,state.autoplayEnabled&&elements.quranAudio.play()}updateNavigationButtons(l.numberInSurah,s.ayahs.length),state.currentSurah=e,state.currentAyah=t,saveState()}catch(c){showError("فشل في تحميل الأية")}showLoading(!1)}function validateRangeInput(e){let t=Number(e.target.value);t>state.totalAyahs?e.target.value=state.totalAyahs:t<1&&(e.target.value=1)}function updateNavigationButtons(e,t){state.rangeModeEnabled?(elements.prevAyah.disabled=e<=state.rangeStart,elements.nextAyah.disabled=e>=state.rangeEnd):(elements.prevAyah.disabled=1===e,elements.nextAyah.disabled=e===t)}function updateControlsVisibility(){let e="selectSurah"!==elements.surahSelect.value,t="selectAudio"!==elements.audioEditionSelect.value;elements.quranAudio.classList.toggle("hidden",!(e&&t)),elements.prevAyah.classList.toggle("hidden",!e),elements.nextAyah.classList.toggle("hidden",!e),elements.quranContent.classList.toggle("hidden",!e),elements.autoPlay.classList.toggle("hidden",!(e&&t)),elements.loop.classList.toggle("hidden",!(e&&t)),elements.rangeMode.classList.toggle("hidden",!e)}function saveState(){localStorage.setItem("Al-Munir_State",JSON.stringify(state))}function loadState(){let e=localStorage.getItem("Al-Munir_State");if(e)try{Object.assign(state,JSON.parse(e)),elements.surahSelect.value=state.currentSurah,elements.editionSelect.value=state.currentEdition,elements.audioEditionSelect.value=state.currentAudioEdition,updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",state.autoplayEnabled),updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",state.loopEnabled),updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",state.rangeModeEnabled),elements.rangeStart.value=state.rangeStart,elements.rangeEnd.value=state.rangeEnd,elements.rangeControls.style.display=state.rangeModeEnabled?"flex":"none",state.currentSurah&&state.currentAyah&&loadAyah(state.currentSurah,state.currentAyah,state.currentEdition)}catch(t){showError("فشل تحميل الحالة المحفوظة")}updateControlsVisibility()}function handleAudioEnd(){state.loopEnabled?elements.quranAudio.play():state.autoplayEnabled&&(state.rangeModeEnabled?state.currentAyah<state.rangeEnd?loadAyah(state.currentSurah,state.currentAyah+1):state.loopEnabled&&loadAyah(state.currentSurah,state.rangeStart):state.currentAyah<state.totalAyahs&&loadAyah(state.currentSurah,state.currentAyah+1))}function setupEventListeners(){elements.quranAudio.addEventListener("ended",handleAudioEnd),elements.toggleAutoplay.addEventListener("click",()=>{state.autoplayEnabled=!state.autoplayEnabled,updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",state.autoplayEnabled),saveState()}),elements.toggleLoop.addEventListener("click",()=>{state.loopEnabled=!state.loopEnabled,updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",state.loopEnabled),saveState()}),elements.toggleRangeMode.addEventListener("click",()=>{state.rangeModeEnabled=!state.rangeModeEnabled,updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",state.rangeModeEnabled),elements.rangeControls.style.display=state.rangeModeEnabled?"flex":"none",state.rangeModeEnabled&&(elements.rangeStart.value=state.currentAyah||1,elements.rangeEnd.value=state.totalAyahs,state.rangeStart=state.currentAyah||1,state.rangeEnd=state.totalAyahs),updateNavigationButtons(state.currentAyah||1,state.totalAyahs),saveState()}),elements.setRange.addEventListener("click",()=>{state.rangeStart=parseInt(elements.rangeStart.value),state.rangeEnd=parseInt(elements.rangeEnd.value),state.rangeStart>state.rangeEnd&&([state.rangeStart,state.rangeEnd]=[state.rangeEnd,state.rangeStart],elements.rangeStart.value=state.rangeStart,elements.rangeEnd.value=state.rangeEnd),!state.currentAyah||state.currentAyah<state.rangeStart||state.currentAyah>state.rangeEnd?loadAyah(state.currentSurah,state.rangeStart):updateNavigationButtons(state.currentAyah,state.totalAyahs),saveState()}),elements.prevAyah.addEventListener("click",()=>{let e=state.rangeModeEnabled?state.rangeStart:1;state.currentAyah>e&&loadAyah(state.currentSurah,state.currentAyah-1)}),elements.nextAyah.addEventListener("click",()=>{let e=state.rangeModeEnabled?state.rangeEnd:state.totalAyahs;state.currentAyah<e&&loadAyah(state.currentSurah,state.currentAyah+1)}),elements.surahSelect.addEventListener("change",e=>{let t=e.target.value;t&&"selectSurah"!==t&&(state.currentSurah=parseInt(t),state.currentAyah=1,loadAyah(state.currentSurah,state.currentAyah),updateControlsVisibility())}),elements.editionSelect.addEventListener("change",e=>{e.target.value&&(state.currentEdition=e.target.value,loadAyah(state.currentSurah,state.currentAyah))}),elements.audioEditionSelect.addEventListener("change",e=>{e.target.value&&(state.currentAudioEdition=e.target.value,loadAyah(state.currentSurah,state.currentAyah),updateControlsVisibility())})}function initializeHiddenElements(){elements.quranAudio.classList.add("hidden"),elements.prevAyah.classList.add("hidden"),elements.nextAyah.classList.add("hidden"),elements.quranContent.classList.add("hidden"),elements.autoPlay.classList.add("hidden"),elements.loop.classList.add("hidden"),elements.rangeMode.classList.add("hidden")}async function init(){initializeHiddenElements(),setupEventListeners(),await Promise.all([loadSurahs(),loadEditions()]),loadState()}init();
