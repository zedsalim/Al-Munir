let API_BASE="https://api.alquran.cloud/v1",state={currentSurah:"selectSurah",currentAyah:null,currentEdition:"selectTafsir",currentAudioEdition:"selectAudio",autoplayEnabled:!1,loopEnabled:!1,rangeModeEnabled:!1,rangeStart:1,rangeEnd:1,totalAyahs:1},elements={surahSelect:$("#surahSelect"),editionSelect:$("#editionSelect"),audioEditionSelect:$("#audioEditionSelect"),loading:$("#loading"),error:$("#error"),arabicText:$("#arabicText"),translationText:$("#translationText"),surahInfo:$("#surahInfo"),ayahInfo:$("#ayahInfo"),quranAudio:$("#quranAudio"),prevAyah:$("#prevAyah"),nextAyah:$("#nextAyah"),toggleAutoplay:$("#toggleAutoplay"),toggleLoop:$("#toggleLoop"),toggleRangeMode:$("#toggleRangeMode"),rangeControls:$("#rangeControls"),rangeStart:$("#rangeStart"),rangeEnd:$("#rangeEnd"),setRange:$("#setRange"),goToFirstAyah:$("#goToFirstAyah"),goToLastAyah:$("#goToLastAyah"),quranContent:$("#quranContent")},allowedIdentifiers={text:["ar.baghawi","ar.jalalayn","ar.miqbas","ar.muyassar","ar.qurtubi","ar.waseet","quran-uthmani"],audio:["ar.abdullahbasfar","ar.abdulsamad","ar.abdurrahmaansudais","ar.ahmedajamy","ar.alafasy","ar.aymanswoaid","ar.hanirifai","ar.hudhaify","ar.husary","ar.husarymujawwad","ar.ibrahimakhbar","ar.mahermuaiqly","ar.muhammadayyoub","ar.muhammadjibreel","ar.saoodshuraym","ar.shaatree"]};function showLoading(e){elements.loading.css("display",e?"block":"none"),e&&elements.error.css("display","none")}function showError(e){elements.error.text(e).css("display","block"),elements.loading.css("display","none")}function updateToggleButton(e,t,a){e.text(t+": "+(a?"On":"Off")).toggleClass("active",a)}async function fetchApi(e){try{return await $.ajax({url:""+API_BASE+e,type:"GET",dataType:"json"})}catch(e){throw showError(e.message||"Network error occurred"),e}}async function loadSurahs(){showLoading(!0);try{var e=await fetchApi("/surah");$.each(e.data,function(e,t){elements.surahSelect.append($("<option>").val(t.number).text(t.number+`. ${t.englishName} (${t.name})`))})}catch(e){showError("فشل في تحميل السورة")}showLoading(!1)}async function loadTextEditions(){showLoading(!0);try{var e=await fetchApi("/edition?format=text");$.each(e.data,function(e,t){allowedIdentifiers.text.includes(t.identifier)&&"quran-uthmani"!==t.identifier&&elements.editionSelect.append($("<option>").val(t.identifier).text(t.name))})}catch(e){showError("فشل في تحميل التفاسير")}showLoading(!1)}async function loadAudioEditions(){showLoading(!0);try{var e=await fetchApi("/edition?format=audio&type=versebyverse");$.each(e.data,function(e,t){allowedIdentifiers.audio.includes(t.identifier)&&elements.audioEditionSelect.append($("<option>").val(t.identifier).text(t.name))})}catch(e){showError("فشل في تحميل التلاوات")}showLoading(!1)}async function loadAyah(a,n,r=state.currentEdition){if(state.currentSurah&&"selectSurah"!==state.currentSurah){showLoading(!0);try{var s,o,l=(await fetchApi(`/ayah/${a}:${n}/quran-uthmani`)).data,i=l.text;let e="",t="";r&&"selectTafsir"!==r&&(s=await fetchApi(`/ayah/${a}:${n}/`+r),e=s.data.text,t=s.data.edition.name),elements.arabicText.html(`
      <div class="verse-container">
        <div class="arabic">${i}</div>
        ${e?`<div class="edition-label">${t}</div>
               <div class="translation">${e}</div>`:""}
      </div>
    `),elements.surahInfo.text(`Surah ${l.surah.englishName} (${l.surah.name})`),elements.ayahInfo.text(`الأية ${l.numberInSurah} من `+l.surah.numberOfAyahs),state.totalAyahs=l.surah.numberOfAyahs,elements.rangeStart.off("input").on("input",validateRangeInput),elements.rangeEnd.off("input").on("input",validateRangeInput),state.currentAudioEdition&&"selectAudio"!==state.currentAudioEdition&&(o=await fetchApi(`/ayah/${a}:${n}/`+state.currentAudioEdition),elements.quranAudio.attr("src",o.data.audio),state.autoplayEnabled)&&elements.quranAudio[0].play(),updateNavigationButtons(l.numberInSurah,l.surah.numberOfAyahs),state.currentSurah=a,state.currentAyah=n,saveState()}catch(e){showError("فشل في تحميل الأية")}showLoading(!1)}}function toggleOptionsBasedOnSurah(){var e="selectSurah"===state.currentSurah;elements.editionSelect.prop("disabled",e),elements.audioEditionSelect.prop("disabled",e),elements.rangeControls.toggleClass("hidden",e),elements.editionSelect.css("cursor",e?"not-allowed":"pointer"),elements.audioEditionSelect.css("cursor",e?"not-allowed":"pointer"),updateControlsVisibility()}function validateRangeInput(e){var e=$(e.target),t=Number(e.val());t>state.totalAyahs?e.val(state.totalAyahs):t<1&&e.val(1)}function updateNavigationButtons(e,t){state.rangeModeEnabled?(elements.prevAyah.prop("disabled",e<=state.rangeStart),elements.nextAyah.prop("disabled",e>=state.rangeEnd)):(elements.prevAyah.prop("disabled",1===e),elements.nextAyah.prop("disabled",e===t))}function updateControlsVisibility(){var e="selectSurah"!==elements.surahSelect.val(),t="selectAudio"!==elements.audioEditionSelect.val();elements.quranAudio.toggleClass("hidden",!(e&&t)),elements.prevAyah.toggleClass("hidden",!e),elements.nextAyah.toggleClass("hidden",!e),elements.quranContent.toggleClass("hidden",!e),elements.toggleAutoplay.toggleClass("hidden",!(e&&t)),elements.toggleLoop.toggleClass("hidden",!(e&&t)),elements.toggleRangeMode.toggleClass("hidden",!e),elements.goToFirstAyah.toggleClass("hidden",!e),elements.goToLastAyah.toggleClass("hidden",!e)}function handleAudioEnd(){state.loopEnabled?elements.quranAudio[0].play():state.autoplayEnabled&&(state.rangeModeEnabled?state.currentAyah<state.rangeEnd?loadAyah(state.currentSurah,state.currentAyah+1):state.loopEnabled&&loadAyah(state.currentSurah,state.rangeStart):state.currentAyah<state.totalAyahs&&loadAyah(state.currentSurah,state.currentAyah+1))}function saveState(){localStorage.setItem("Al-Munir_State",JSON.stringify(state))}function loadState(){var e=localStorage.getItem("Al-Munir_State");if(e)try{Object.assign(state,JSON.parse(e)),elements.surahSelect.val(state.currentSurah),elements.editionSelect.val(state.currentEdition),elements.audioEditionSelect.val(state.currentAudioEdition),updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",state.autoplayEnabled),updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",state.loopEnabled),updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",state.rangeModeEnabled),elements.rangeStart.val(state.rangeStart),elements.rangeEnd.val(state.rangeEnd),elements.rangeControls.css("display",state.rangeModeEnabled?"flex":"none"),state.currentSurah&&state.currentAyah&&loadAyah(state.currentSurah,state.currentAyah,state.currentEdition)}catch(e){showError("فشل تحميل الحالة المحفوظة")}toggleOptionsBasedOnSurah()}function setupEventListeners(){elements.quranAudio.on("ended",handleAudioEnd),elements.toggleAutoplay.on("click",function(){state.autoplayEnabled=!state.autoplayEnabled,updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",state.autoplayEnabled),saveState()}),elements.toggleLoop.on("click",function(){state.loopEnabled=!state.loopEnabled,updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",state.loopEnabled),saveState()}),elements.toggleRangeMode.on("click",function(){state.rangeModeEnabled=!state.rangeModeEnabled,updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",state.rangeModeEnabled),elements.rangeControls.css("display",state.rangeModeEnabled?"flex":"none"),state.rangeModeEnabled&&(elements.rangeStart.val(1),elements.rangeEnd.val(state.totalAyahs),state.rangeStart=1,state.rangeEnd=state.totalAyahs),updateNavigationButtons(state.currentAyah||1,state.totalAyahs),saveState()}),elements.setRange.on("click",function(){state.rangeStart=parseInt(elements.rangeStart.val()),state.rangeEnd=parseInt(elements.rangeEnd.val()),state.rangeStart>state.rangeEnd&&([state.rangeStart,state.rangeEnd]=[state.rangeEnd,state.rangeStart],elements.rangeStart.val(state.rangeStart),elements.rangeEnd.val(state.rangeEnd)),!state.currentAyah||state.currentAyah<state.rangeStart||state.currentAyah>state.rangeEnd?loadAyah(state.currentSurah,state.rangeStart):updateNavigationButtons(state.currentAyah,state.totalAyahs),saveState()}),elements.goToFirstAyah.on("click",function(){var e;state.currentSurah&&(e=state.rangeModeEnabled?state.rangeStart:1,loadAyah(state.currentSurah,e))}),elements.goToLastAyah.on("click",function(){var e;state.currentSurah&&(e=state.rangeModeEnabled?state.rangeEnd:state.totalAyahs,loadAyah(state.currentSurah,e))}),elements.prevAyah.on("click",function(){var e=state.rangeModeEnabled?state.rangeStart:1;state.currentAyah>e&&loadAyah(state.currentSurah,state.currentAyah-1)}),elements.nextAyah.on("click",function(){var e=state.rangeModeEnabled?state.rangeEnd:state.totalAyahs;state.currentAyah<e&&loadAyah(state.currentSurah,state.currentAyah+1)}),elements.surahSelect.on("change",function(){var e=$(this).val();e&&"selectSurah"!==e?(state.currentSurah=parseInt(e),state.currentAyah=1,loadAyah(state.currentSurah,state.currentAyah).then(()=>{state.rangeModeEnabled&&(state.rangeStart=1,state.rangeEnd=state.totalAyahs,elements.rangeStart.val(1),elements.rangeEnd.val(state.totalAyahs))})):(state.currentSurah="selectSurah",state.currentAyah=null,elements.quranAudio[0].pause(),elements.quranAudio[0].currentTime=0),toggleOptionsBasedOnSurah(),saveState()}),elements.editionSelect.on("change",function(){var e=$(this).val();e?(state.currentEdition=e,loadAyah(state.currentSurah,state.currentAyah)):state.currentEdition="selectTafsir",saveState()}),elements.audioEditionSelect.on("change",function(){var e=$(this).val();e?(state.currentAudioEdition=e,loadAyah(state.currentSurah,state.currentAyah)):state.currentAudioEdition="selectAudio",updateControlsVisibility(),saveState()})}async function init(){setupEventListeners(),await Promise.all([loadSurahs(),loadTextEditions(),loadAudioEditions()]),loadState(),toggleOptionsBasedOnSurah()}$(document).ready(function(){init()});