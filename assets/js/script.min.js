const API_BASE="https://api.alquran.cloud/v1",state={currentSurah:"selectSurah",currentAyah:null,currentEdition:"selectTafsir",currentAudioEdition:"selectAudio",autoplayEnabled:!1,loopEnabled:!1,rangeModeEnabled:!1,rangeStart:1,rangeEnd:1,totalAyahs:1},elements={surahSelect:$("#surahSelect"),editionSelect:$("#editionSelect"),audioEditionSelect:$("#audioEditionSelect"),loading:$("#loading"),error:$("#error"),arabicText:$("#arabicText"),translationText:$("#translationText"),surahInfo:$("#surahInfo"),ayahInfo:$("#ayahInfo"),quranAudio:$("#quranAudio"),prevAyah:$("#prevAyah"),nextAyah:$("#nextAyah"),toggleAutoplay:$("#toggleAutoplay"),toggleLoop:$("#toggleLoop"),toggleRangeMode:$("#toggleRangeMode"),rangeControls:$("#rangeControls"),rangeStart:$("#rangeStart"),rangeEnd:$("#rangeEnd"),setRange:$("#setRange"),quranContent:$("#quranContent")},allowedIdentifiers={text:["ar.baghawi","ar.jalalayn","ar.miqbas","ar.muyassar","ar.qurtubi","ar.waseet","quran-uthmani",],audio:["ar.abdullahbasfar","ar.abdulsamad","ar.abdurrahmaansudais","ar.ahmedajamy","ar.alafasy","ar.aymanswoaid","ar.hanirifai","ar.hudhaify","ar.husary","ar.husarymujawwad","ar.ibrahimakhbar","ar.mahermuaiqly","ar.muhammadayyoub","ar.muhammadjibreel","ar.saoodshuraym","ar.shaatree",]};function showLoading(e){elements.loading.css("display",e?"block":"none"),e&&elements.error.css("display","none")}function showError(e){elements.error.text(e).css("display","block"),elements.loading.css("display","none")}function updateToggleButton(e,t,a){e.text(`${t}: ${a?"On":"Off"}`).toggleClass("active",a)}async function fetchApi(e){try{let t=await $.ajax({url:`https://api.alquran.cloud/v1${e}`,type:"GET",dataType:"json"});return t}catch(a){throw showError(a.message||"Network error occurred"),a}}async function loadSurahs(){showLoading(!0);try{let e=await fetchApi("/surah");$.each(e.data,function(e,t){elements.surahSelect.append($("<option>").val(t.number).text(`${t.number}. ${t.englishName} (${t.name})`))})}catch(t){showError("فشل في تحميل السورة")}showLoading(!1)}async function loadTextEditions(){showLoading(!0);try{let e=await fetchApi("/edition?format=text");$.each(e.data,function(e,t){allowedIdentifiers.text.includes(t.identifier)&&"quran-uthmani"!==t.identifier&&elements.editionSelect.append($("<option>").val(t.identifier).text(t.name))})}catch(t){showError("فشل في تحميل التفاسير")}showLoading(!1)}async function loadAudioEditions(){showLoading(!0);try{let e=await fetchApi("/edition?format=audio&type=versebyverse");$.each(e.data,function(e,t){allowedIdentifiers.audio.includes(t.identifier)&&elements.audioEditionSelect.append($("<option>").val(t.identifier).text(t.name))})}catch(t){showError("فشل في تحميل التلاوات")}showLoading(!1)}async function loadAyah(e,t,a=state.currentEdition){if(state.currentSurah&&"selectSurah"!==state.currentSurah){showLoading(!0);try{let n=await fetchApi(`/ayah/${e}:${t}/quran-uthmani`),r=n.data,s=r.text,o="",l="";if(a&&"selectTafsir"!==a){let i=await fetchApi(`/ayah/${e}:${t}/${a}`);o=i.data.text,l=i.data.edition.name}if(elements.arabicText.html(`
      <div class="verse-container">
        <div class="arabic">${s}</div>
        ${o?`<div class="edition-label">${l}</div>
               <div class="translation">${o}</div>`:""}
      </div>
    `),elements.surahInfo.text(`Surah ${r.surah.englishName} (${r.surah.name})`),elements.ayahInfo.text(`الأية ${r.numberInSurah} من ${r.surah.numberOfAyahs}`),state.totalAyahs=r.surah.numberOfAyahs,elements.rangeStart.off("input").on("input",validateRangeInput),elements.rangeEnd.off("input").on("input",validateRangeInput),state.currentAudioEdition&&"selectAudio"!==state.currentAudioEdition){let d=await fetchApi(`/ayah/${e}:${t}/${state.currentAudioEdition}`);elements.quranAudio.attr("src",d.data.audio),state.autoplayEnabled&&elements.quranAudio[0].play()}updateNavigationButtons(r.numberInSurah,r.surah.numberOfAyahs),state.currentSurah=e,state.currentAyah=t,saveState()}catch(u){showError("فشل في تحميل الأية")}showLoading(!1)}}function toggleOptionsBasedOnSurah(){let e="selectSurah"===state.currentSurah;elements.editionSelect.prop("disabled",e),elements.audioEditionSelect.prop("disabled",e),elements.editionSelect.css("cursor",e?"not-allowed":"pointer"),elements.audioEditionSelect.css("cursor",e?"not-allowed":"pointer"),updateControlsVisibility()}function validateRangeInput(e){let t=$(e.target),a=Number(t.val());a>state.totalAyahs?t.val(state.totalAyahs):a<1&&t.val(1)}function updateNavigationButtons(e,t){state.rangeModeEnabled?(elements.prevAyah.prop("disabled",e<=state.rangeStart),elements.nextAyah.prop("disabled",e>=state.rangeEnd)):(elements.prevAyah.prop("disabled",1===e),elements.nextAyah.prop("disabled",e===t))}function updateControlsVisibility(){let e="selectSurah"!==elements.surahSelect.val(),t="selectAudio"!==elements.audioEditionSelect.val();elements.quranAudio.toggleClass("hidden",!(e&&t)),elements.prevAyah.toggleClass("hidden",!e),elements.nextAyah.toggleClass("hidden",!e),elements.quranContent.toggleClass("hidden",!e),elements.toggleAutoplay.toggleClass("hidden",!(e&&t)),elements.toggleLoop.toggleClass("hidden",!(e&&t)),elements.toggleRangeMode.toggleClass("hidden",!e)}function handleAudioEnd(){state.loopEnabled?elements.quranAudio[0].play():state.autoplayEnabled&&(state.rangeModeEnabled?state.currentAyah<state.rangeEnd?loadAyah(state.currentSurah,state.currentAyah+1):state.loopEnabled&&loadAyah(state.currentSurah,state.rangeStart):state.currentAyah<state.totalAyahs&&loadAyah(state.currentSurah,state.currentAyah+1))}function saveState(){localStorage.setItem("Al-Munir_State",JSON.stringify(state))}function loadState(){let e=localStorage.getItem("Al-Munir_State");if(e)try{Object.assign(state,JSON.parse(e)),elements.surahSelect.val(state.currentSurah),elements.editionSelect.val(state.currentEdition),elements.audioEditionSelect.val(state.currentAudioEdition),updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",state.autoplayEnabled),updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",state.loopEnabled),updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",state.rangeModeEnabled),elements.rangeStart.val(state.rangeStart),elements.rangeEnd.val(state.rangeEnd),elements.rangeControls.css("display",state.rangeModeEnabled?"flex":"none"),state.currentSurah&&state.currentAyah&&loadAyah(state.currentSurah,state.currentAyah,state.currentEdition)}catch(t){showError("فشل تحميل الحالة المحفوظة")}toggleOptionsBasedOnSurah()}function setupEventListeners(){elements.quranAudio.on("ended",handleAudioEnd),elements.toggleAutoplay.on("click",function(){state.autoplayEnabled=!state.autoplayEnabled,updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",state.autoplayEnabled),saveState()}),elements.toggleLoop.on("click",function(){state.loopEnabled=!state.loopEnabled,updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",state.loopEnabled),saveState()}),elements.toggleRangeMode.on("click",function(){state.rangeModeEnabled=!state.rangeModeEnabled,updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",state.rangeModeEnabled),elements.rangeControls.css("display",state.rangeModeEnabled?"flex":"none"),state.rangeModeEnabled&&(elements.rangeStart.val(state.currentAyah||1),elements.rangeEnd.val(state.totalAyahs),state.rangeStart=state.currentAyah||1,state.rangeEnd=state.totalAyahs),updateNavigationButtons(state.currentAyah||1,state.totalAyahs),saveState()}),elements.setRange.on("click",function(){state.rangeStart=parseInt(elements.rangeStart.val()),state.rangeEnd=parseInt(elements.rangeEnd.val()),state.rangeStart>state.rangeEnd&&([state.rangeStart,state.rangeEnd]=[state.rangeEnd,state.rangeStart],elements.rangeStart.val(state.rangeStart),elements.rangeEnd.val(state.rangeEnd)),!state.currentAyah||state.currentAyah<state.rangeStart||state.currentAyah>state.rangeEnd?loadAyah(state.currentSurah,state.rangeStart):updateNavigationButtons(state.currentAyah,state.totalAyahs),saveState()}),elements.prevAyah.on("click",function(){let e=state.rangeModeEnabled?state.rangeStart:1;state.currentAyah>e&&loadAyah(state.currentSurah,state.currentAyah-1)}),elements.nextAyah.on("click",function(){let e=state.rangeModeEnabled?state.rangeEnd:state.totalAyahs;state.currentAyah<e&&loadAyah(state.currentSurah,state.currentAyah+1)}),elements.surahSelect.on("change",function(){let e=$(this).val();e&&"selectSurah"!==e?(state.currentSurah=parseInt(e),state.currentAyah=1,loadAyah(state.currentSurah,state.currentAyah)):(state.currentSurah="selectSurah",state.currentAyah=null,elements.quranAudio[0].pause(),elements.quranAudio[0].currentTime=0),toggleOptionsBasedOnSurah(),saveState()}),elements.editionSelect.on("change",function(){let e=$(this).val();e?(state.currentEdition=e,loadAyah(state.currentSurah,state.currentAyah)):state.currentEdition="selectTafsir",saveState()}),elements.audioEditionSelect.on("change",function(){let e=$(this).val();e?(state.currentAudioEdition=e,loadAyah(state.currentSurah,state.currentAyah)):state.currentAudioEdition="selectAudio",updateControlsVisibility(),saveState()})}async function init(){setupEventListeners(),await Promise.all([loadSurahs(),loadTextEditions(),loadAudioEditions()]),loadState(),toggleOptionsBasedOnSurah()}$(document).ready(function(){init()});
